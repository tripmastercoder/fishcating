// Start a new round (selects 3 questions)
function startRound() {
  score = 0;
  totalpoints = 0; // reset total points
  roundNumber = 0;  // start at 0

  // Filter questions by answer count
  const q3to5 = getQuestionsByAnswerCount(3,6);
  const q6to10 = getQuestionsByAnswerCount(7,15);
  const q11plus = getQuestionsByAnswerCount(16, Infinity);

  // Pick one question from each category
  roundQuestions = [
    getRandomItem(q3to5),
    getRandomItem(q6to10),
    getRandomItem(q11plus)
  ];

  // Calculate total points
  totalpoints = roundQuestions.reduce((sum, q) => {
    let answers = [];
    if (q.answers) answers = q.answers;
    else if (q.categoryKey && values[q.categoryKey]) {
      if (Array.isArray(values[q.categoryKey])) answers = values[q.categoryKey];
      else {
        const keys = Object.keys(values[q.categoryKey]);
        const maxKey = keys.reduce((a,b) => values[q.categoryKey][a].length > values[q.categoryKey][b].length ? a : b);
        answers = values[q.categoryKey][maxKey];
      }
    }
    return sum + answers.length;
  }, 0);

  currentIndex = 0; // start with first question
  startQuestion();
}

// Start a question (each question = one round)
function startQuestion() {
  if (currentIndex >= roundQuestions.length) { 
    showGameOver(); 
    return; 
  }

  const q = roundQuestions[currentIndex];
  let xVal = "";

  // Determine question text and answers
  if (q.text && q.answers) {
    currentQuestionText = q.text;
    currentAnswers = [...q.answers];
  } else if (q.categoryKey && typeof values[q.categoryKey] === "object" && !Array.isArray(values[q.categoryKey])) {
    const keys = Object.keys(values[q.categoryKey]);
    xVal = getRandomItem(keys);
    currentQuestionText = q.template.replace("{X}", xVal);
    currentAnswers = [...values[q.categoryKey][xVal]];
  } else {
    xVal = "";
    currentQuestionText = q.template ? q.template.replace("{X}", xVal) : "";
    currentAnswers = Array.isArray(values[q.categoryKey]) ? [...values[q.categoryKey]] : [];
  }

  currentAnswers.sort();
  revealed = currentAnswers.map(() => false);

  // Increment round number and display
  roundNumber++;
  document.getElementById("question").textContent = 
    `Round ${roundNumber}: ${currentQuestionText}`;

  updateCounter();
  document.getElementById("feedback").textContent = "";
  document.getElementById("guess").value = "";
  renderAnswers();
}
